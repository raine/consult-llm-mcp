#!/usr/bin/env bash
set -euo pipefail

bump="${1:-}"

if [[ -z "$bump" ]]; then
	echo "usage: scripts/publish <patch|minor|major>" >&2
	exit 1
fi

if [[ "$bump" != "patch" && "$bump" != "minor" && "$bump" != "major" ]]; then
	echo "error: bump must be patch, minor, or major (got: $bump)" >&2
	exit 1
fi

# Fail fast if npm auth is missing or expired
echo "Checking npm auth..."
npm whoami

# Fail fast if there are uncommitted changes
if ! git diff --quiet || ! git diff --cached --quiet; then
	echo "error: working tree has uncommitted changes" >&2
	exit 1
fi

# Bump version (creates commit + tag)
npm version "$bump"
version=$(node -p "require('./package.json').version")

# Publish â€” if this fails, roll back the version commit and tag
if ! npm publish; then
	echo "Publish failed, rolling back v${version}..." >&2
	git tag -d "v${version}"
	git reset --hard HEAD~1
	exit 1
fi

git push
git push --tags

echo "Published v${version}"
